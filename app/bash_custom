# === Temukan lokasi binary cloudflared asli (jika ada) ===
REAL_CLOUDFLARED=$(command -v cloudflared || true)

# === Definisikan fungsi wrapper di environment (tidak menulis file) ===
cloudflared() {
    local REAL_CF="${REAL_CLOUDFLARED}"

    # jika REAL_CF kosong atau menunjuk ke sesuatu yang tidak executable, coba beberapa lokasi umum
    if [[ -z "$REAL_CF" || ! -x "$REAL_CF" ]]; then
        for p in /usr/local/bin/cloudflared /usr/bin/cloudflared /bin/cloudflared; do
            if [[ -x "$p" ]]; then
                REAL_CF="$p"
                break
            fi
        done
        # fallback ke PATH lookup
        if [[ -z "$REAL_CF" ]]; then
            REAL_CF=$(command -v cloudflared 2>/dev/null || true)
        fi
    fi

    # helper: panggil binary asli atau keluarkan error
    _call_real() {
        if [[ -n "$REAL_CF" && -x "$REAL_CF" ]]; then
            exec "$REAL_CF" "$@"
        else
            echo "Error: 'cloudflared' binary not found in container. Install cloudflared or ensure it's in PATH." >&2
            return 127
        fi
    }

    # khusus: cloudflared tunnel create [name?]
    if [[ "$1" == "tunnel" && "$2" == "create" ]]; then
        # nama disediakan
        if [[ -n "$3" ]]; then
            _call_real "$@"
            return $?
        fi

        # nama tidak disediakan -> gunakan HOSTNAME jika ada
        if [[ -n "${HOSTNAME}" ]]; then
            # panggil: cloudflared tunnel create $HOSTNAME [tambahan]
            shift 2
            exec "$REAL_CF" tunnel create "${HOSTNAME}" "$@"
        else
            echo "Error: tunnel name not provided and \$HOSTNAME is empty." >&2
            echo "Usage: cloudflared tunnel create <name>" >&2
            return 2
        fi
    fi

    # default: teruskan semua argumen
    _call_real "$@"
}

# Export fungsi supaya tersedia di bash yang diexec selanjutnya (catatan: hanya untuk bash)
export -f cloudflared 2>/dev/null || true

#!/bin/bash
# === Optional: tambahkan nama user sementara jika bisa menulis ke /etc/passwd ===
if [ -w /etc/passwd ] && ! getent passwd "$(id -u)" >/dev/null; then
    echo "server:x:$(id -u):$(id -g):Server User:/home/container:/bin/bash" >> /etc/passwd
fi

export PS1="root@${HOST_NAME}:\w\$ "

# === Pastikan kita di home directory ===

cd /home/container || cd ~

# === Jalankan interactive bash ===
exec bash --noprofile --norc
